#!/usr/bin/env bash
# claw-drive ‚Äî AI-managed personal drive
# https://github.com/dissaozw/claw-drive

set -euo pipefail

CLAW_DRIVE_VERSION="0.2.0"
# Resolve symlinks to find the real script location
CLAW_DRIVE_SCRIPT="${BASH_SOURCE[0]}"
while [[ -L "$CLAW_DRIVE_SCRIPT" ]]; do
  CLAW_DRIVE_LINK="$(readlink "$CLAW_DRIVE_SCRIPT")"
  if [[ "$CLAW_DRIVE_LINK" == /* ]]; then
    CLAW_DRIVE_SCRIPT="$CLAW_DRIVE_LINK"
  else
    CLAW_DRIVE_SCRIPT="$(dirname "$CLAW_DRIVE_SCRIPT")/$CLAW_DRIVE_LINK"
  fi
done
CLAW_DRIVE_ROOT="$(cd "$(dirname "$CLAW_DRIVE_SCRIPT")/.." && pwd)"

# Load libraries
source "$CLAW_DRIVE_ROOT/lib/config.sh"
source "$CLAW_DRIVE_ROOT/lib/index.sh"
source "$CLAW_DRIVE_ROOT/lib/dedup.sh"
source "$CLAW_DRIVE_ROOT/lib/sync.sh"
source "$CLAW_DRIVE_ROOT/lib/migrate.sh"

# --- Commands ---

cmd_init() {
  # Accept optional path argument
  if [[ -n "${1:-}" ]]; then
    CLAW_DRIVE_DIR="$1"
  fi

  # Resolve to absolute path
  if [[ "$CLAW_DRIVE_DIR" != /* ]]; then
    CLAW_DRIVE_DIR="$(cd "$(dirname "$CLAW_DRIVE_DIR")" 2>/dev/null && pwd)/$(basename "$CLAW_DRIVE_DIR")"
  fi

  # Update all derived paths
  CLAW_DRIVE_INDEX="$CLAW_DRIVE_DIR/INDEX.md"
  CLAW_DRIVE_HASHES="$CLAW_DRIVE_DIR/.hashes"
  CLAW_DRIVE_SYNC_CONFIG="$CLAW_DRIVE_DIR/.sync-config"
  CLAW_DRIVE_SYNC_STATE="$CLAW_DRIVE_DIR/.sync-state"

  # Save path to config
  mkdir -p "$(dirname "$CLAW_DRIVE_CONFIG_FILE")"
  echo "$CLAW_DRIVE_DIR" > "$CLAW_DRIVE_CONFIG_FILE"

  echo "üóÑÔ∏è  Initializing Claw Drive at $CLAW_DRIVE_DIR"
  echo ""

  for cat in "${CLAW_DRIVE_CATEGORIES[@]}"; do
    mkdir -p "$CLAW_DRIVE_DIR/$cat"
    echo "  üìÇ $cat/"
  done

  if [[ ! -f "$CLAW_DRIVE_INDEX" ]]; then
    cat > "$CLAW_DRIVE_INDEX" <<'EOF'
# üìÅ Claw Drive ‚Äî Personal File Index

## Directory Structure
- **documents/** ‚Äî general docs, letters, forms
- **finance/** ‚Äî tax, bank statements, investment docs
- **insurance/** ‚Äî insurance policies, claims, coverage docs
- **medical/** ‚Äî health records, prescriptions
- **travel/** ‚Äî tickets, itineraries, visas, bookings
- **identity/** ‚Äî ID scans, certificates (‚ö†Ô∏è sensitive)
- **receipts/** ‚Äî purchase receipts, warranties, invoices
- **contracts/** ‚Äî leases, employment, legal agreements
- **photos/** ‚Äî personal photos, scans
- **misc/** ‚Äî anything that doesn't fit above

## File Index
<!-- Auto-maintained by Claw Drive. Format: date | path | description | tags | source -->

| Date | Path | Description | Tags | Source |
|------|------|-------------|------|--------|

---
*Last updated: YYYY-MM-DD*
EOF
    echo "  üìÑ INDEX.md created"
  else
    echo "  üìÑ INDEX.md exists"
  fi

  touch "$CLAW_DRIVE_HASHES"
  echo ""
  echo "‚úÖ Claw Drive ready at $CLAW_DRIVE_DIR"
}

cmd_store() {
  local file="" category="" description="" tags="" source_name=""

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --category|-c) category="$2"; shift 2 ;;
      --desc|-d) description="$2"; shift 2 ;;
      --tags|-t) tags="$2"; shift 2 ;;
      --source|-s) source_name="$2"; shift 2 ;;
      --name|-n) local custom_name="$2"; shift 2 ;;
      --json) local json_output=true; shift ;;
      *) file="$1"; shift ;;
    esac
  done

  if [[ -z "$file" || ! -f "$file" ]]; then
    echo "‚ùå Usage: claw-drive store <file> --category <cat> --desc <description> [--name <name>] [--tags <tags>] [--source <source>]"
    return 1
  fi

  claw_drive_init || return 1

  # Check for duplicates
  local existing
  if existing=$(dedup_check "$file"); then
    echo "‚ö†Ô∏è  Duplicate detected! File already exists at: $CLAW_DRIVE_DIR/$existing"
    return 1
  fi

  if [[ -z "$category" ]]; then
    echo "‚ùå --category is required"
    return 1
  fi

  if [[ -z "$description" ]]; then
    echo "‚ùå --desc is required"
    return 1
  fi

  # Build filename
  local basename
  basename="${custom_name:-$(basename "$file")}"
  local dest="$CLAW_DRIVE_DIR/$category/$basename"

  # Copy file
  mkdir -p "$CLAW_DRIVE_DIR/$category"
  cp "$file" "$dest"

  # Register hash
  dedup_register "$dest" "$category/$basename"

  # Update index
  local date_str
  date_str=$(date +%Y-%m-%d)
  local index_row="| $date_str | $category/$basename | $description | ${tags:-} | ${source_name:-manual} |"

  # Insert before the trailing --- line (portable sed for macOS/Linux)
  if grep -q '^---$' "$CLAW_DRIVE_INDEX"; then
    if [[ "$OSTYPE" == "darwin"* ]]; then
      # macOS
      sed -i '' "/^---$/i\\
$index_row
" "$CLAW_DRIVE_INDEX"
    else
      # Linux
      sed -i "/^---$/i\\
$index_row
" "$CLAW_DRIVE_INDEX"
    fi
  else
    echo "$index_row" >> "$CLAW_DRIVE_INDEX"
  fi

  if [[ "${json_output:-}" == "true" ]]; then
    printf '{"status":"stored","path":"%s","category":"%s","tags":"%s","hash":"%s"}\n' \
      "$category/$basename" "$category" "${tags:-}" "$(dedup_hash "$dest")"
  else
    echo "‚úÖ Stored: $category/$basename"
    [[ -n "$tags" ]] && echo "   Tags: $tags"
    echo "   Description: $description"
  fi
}

cmd_status() {
  local format="table"
  [[ "${1:-}" == "--json" ]] && format="json"

  echo "üóÑÔ∏è  Claw Drive Status"
  echo ""
  echo "üìÇ Directory: $CLAW_DRIVE_DIR"

  if [[ -d "$CLAW_DRIVE_DIR" ]]; then
    local file_count
    file_count=$(find "$CLAW_DRIVE_DIR" -type f \
      ! -name '.*' ! -name 'INDEX.md' ! -path '*/.git/*' | wc -l | xargs)
    echo "üìÑ Files: $file_count"

    local total_size
    total_size=$(du -sh "$CLAW_DRIVE_DIR" 2>/dev/null | awk '{print $1}')
    echo "üíæ Size: $total_size"
  else
    echo "‚ùå Directory not found"
  fi

  echo ""
  dedup_status "$format"
  echo ""
  sync_status "$format"
}

cmd_sync() {
  local subcmd="${1:-help}"
  shift || true

  case "$subcmd" in
    auth)    sync_auth ;;
    setup)   sync_setup ;;
    push)    sync_push ;;
    start)   sync_start ;;
    stop)    sync_stop ;;
    status)  sync_status "${1:-table}" ;;
    _watch)  sync_watch_loop ;;
    help|*)
      echo "Usage: claw-drive sync <command>"
      echo ""
      echo "Commands:"
      echo "  auth    ‚Äî authorize Google Drive (one-time, opens browser)"
      echo "  setup   ‚Äî check dependencies and configuration"
      echo "  push    ‚Äî one-shot sync to remote"
      echo "  start   ‚Äî start background sync daemon"
      echo "  stop    ‚Äî stop background sync daemon"
      echo "  status  ‚Äî show sync status"
      ;;
  esac
}

cmd_migrate() {
  local subcmd="${1:-help}"
  shift || true

  case "$subcmd" in
    scan)
      local source_dir="${1:-}"
      local output="${2:-migration-plan.json}"
      if [[ -z "$source_dir" ]]; then
        echo "‚ùå Usage: claw-drive migrate scan <source-dir> [output.json]"
        return 1
      fi
      migrate_scan "$source_dir" "$output"
      ;;
    apply)
      local plan="${1:-migration-plan.json}"
      local dry_run="false"
      [[ "${2:-}" == "--dry-run" ]] && dry_run="true"
      migrate_apply "$plan" "$dry_run"
      ;;
    summary)
      local plan="${1:-migration-plan.json}"
      migrate_summary "$plan"
      ;;
    help|*)
      echo "Usage: claw-drive migrate <command>"
      echo ""
      echo "Commands:"
      echo "  scan <source-dir> [output.json]   ‚Äî scan directory, output plan"
      echo "  summary [plan.json]               ‚Äî show plan summary"
      echo "  apply [plan.json] [--dry-run]     ‚Äî execute migration plan"
      echo ""
      echo "Workflow:"
      echo "  1. claw-drive migrate scan ~/messy-folder"
      echo "  2. AI agent classifies files in migration-plan.json"
      echo "  3. claw-drive migrate summary    (review)"
      echo "  4. claw-drive migrate apply      (execute)"
      ;;
  esac
}

cmd_version() {
  echo "claw-drive $CLAW_DRIVE_VERSION"
}

cmd_help() {
  cat <<EOF
üóÑÔ∏è  Claw Drive ‚Äî AI-managed personal drive

Usage: claw-drive <command> [options]

Commands:
  init [path]                   Initialize drive at path (default: ~/claw-drive)
  store <file> [options]        Store a file with categorization
  status [--json]               Show drive status
  migrate <subcommand>          Migrate files from existing directory
  sync auth                     Authorize Google Drive (one-time)
  sync <subcommand>             Manage Google Drive sync
  version                       Show version
  help                          Show this help

Store options:
  --category, -c <category>     Target category (required)
  --desc, -d <description>      File description (required)
  --name, -n <filename>         Custom filename (default: original name)
  --tags, -t <tag1,tag2>        Comma-separated tags
  --source, -s <source>         Source (email, telegram, manual)
  --json                        JSON output

Environment:
  CLAW_DRIVE_DIR                Drive directory (default: ~/claw-drive)

https://github.com/dissaozw/claw-drive
EOF
}

# --- Main ---

case "${1:-help}" in
  init)     shift; cmd_init "$@" ;;
  store)    shift; cmd_store "$@" ;;
  status)   shift; cmd_status "$@" ;;
  migrate)  shift; cmd_migrate "$@" ;;
  sync)     shift; cmd_sync "$@" ;;
  version|--version|-v) cmd_version ;;
  help|--help|-h) cmd_help ;;
  *)
    echo "Unknown command: $1"
    echo "Run 'claw-drive help' for usage."
    exit 1
    ;;
esac
